# ADR-001: Database Schema Redesign for Performance Optimization

**Status**: In Progress
**Date**: 2025-09-16
**Deciders**: Conductor Agent, dev-agent
**Technical Story**: TASK-101 Database Schema Redesign as part of comprehensive modernization (Method 5)

## Context

The current database schema has several performance bottlenecks and design issues that need to be addressed:

### Current Issues Identified:

1. **Foreign Key Constraint Conflicts**:
   - Existing `embeddings` table has foreign key constraint to `vec_embeddings` table
   - Causing compatibility issues with sqlite-vec extension integration
   - Migration script (`migrate-db.js`) exists but needs enhancement

2. **Suboptimal Indexing Strategy**:
   - Current indexing in `schema-migrations.ts` is basic
   - Missing compound indexes for common query patterns
   - No performance monitoring for index usage

3. **Vector Integration Gaps**:
   - sqlite-vec extension integration not fully optimized
   - Fallback mechanism lacks performance monitoring
   - Vector embeddings table structure needs modernization

4. **Storage Layer Architecture**:
   - Current `GraphStorageImpl` uses synchronous patterns in async methods
   - Connection pooling not fully utilized
   - Batch operations could be more efficient

## Decision

We will implement **Database Schema v2** with the following comprehensive changes:

### 1. Schema Modernization

**Migration Strategy**:
- Extend current migration system to version 2
- Implement safe transition with data preservation
- Add comprehensive rollback capabilities

**New Schema Features**:
- Optimized entity-relationship model
- Enhanced vector embeddings integration
- Performance-focused indexing strategy
- Advanced caching mechanisms

### 2. Performance Optimization

**Indexing Strategy**:
- Compound indexes for common query patterns
- Partial indexes for performance-critical operations
- FTS5 optimization for semantic search

**Connection Management**:
- Enhanced connection pooling
- Transaction optimization
- Async/await pattern implementation

### 3. Vector Store Integration

**sqlite-vec Enhancement**:
- Direct integration with optimized schema
- Graceful fallback with performance monitoring
- Hardware acceleration support

**Embedding Management**:
- Separate vector storage from metadata
- Optimized similarity search operations
- Memory-efficient caching

## Consequences

### Positive:
- **10-100x performance improvement** in vector similarity searches
- **2-5x reduction** in memory usage for large datasets
- **Enhanced scalability** for large codebases
- **Better error handling** and monitoring
- **Modern async patterns** throughout storage layer

### Negative:
- **Complex migration process** requiring careful testing
- **Temporary downtime** during migration
- **Increased development time** for comprehensive testing
- **Risk of data loss** if migration fails (mitigated by backups)

### Neutral:
- **Backward compatibility** maintained where possible
- **Gradual rollout** allows for incremental testing
- **Comprehensive documentation** for future maintenance

## Implementation Plan

### Phase 1: Schema Design (Current)
- [x] Analyze existing schema issues
- [x] Design migration strategy
- [ ] Create migration v2 definition
- [ ] Design new indexing strategy

### Phase 2: Migration Implementation
- [ ] Enhance migrate-db.js with v2 support
- [ ] Implement data preservation mechanisms
- [ ] Add comprehensive backup and rollback
- [ ] Create migration validation tests

### Phase 3: Storage Layer Modernization
- [ ] Update GraphStorageImpl with async patterns
- [ ] Implement enhanced connection pooling
- [ ] Add performance monitoring
- [ ] Optimize batch operations

### Phase 4: Vector Integration
- [ ] Integrate sqlite-vec with new schema
- [ ] Implement fallback mechanisms
- [ ] Add hardware acceleration support
- [ ] Create performance benchmarks

### Phase 5: Validation and Testing
- [ ] Comprehensive migration testing
- [ ] Performance regression testing
- [ ] Integration testing with MCP tools
- [ ] Documentation and monitoring setup

## Technical Specifications

### Database Engine Configuration:
```sql
-- WAL mode for concurrent access
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = 10000;
PRAGMA temp_store = MEMORY;
PRAGMA mmap_size = 268435456; -- 256MB
```

### New Schema Features:
- **Enhanced Entity Table**: Optimized for graph traversal
- **Vector Embeddings Table**: Direct sqlite-vec integration
- **Performance Monitoring**: Built-in metrics collection
- **Advanced Caching**: LRU cache with TTL support

### Performance Targets:
- **Query Response**: <100ms for simple queries, <1s for complex analysis
- **Throughput**: 100+ files/second parsing
- **Memory Usage**: <1GB peak for large repositories
- **Concurrent Operations**: 10+ simultaneous queries

## Monitoring and Validation

### Key Metrics:
- Migration completion time and success rate
- Query performance before/after comparison
- Memory usage optimization validation
- Vector search performance benchmarks

### Success Criteria:
- Zero data loss during migration
- Performance improvements meet targets
- All existing MCP tools maintain functionality
- Comprehensive monitoring and logging active

---

**Next Steps**: Proceed with Phase 1 completion - create migration v2 definition and enhanced indexing strategy.

**Related Tasks**: TASK-102 (Vector Store Optimization), TASK-103 (Storage Layer Modernization)

**References**:
- Current schema: `src/storage/schema-migrations.ts`
- Storage implementation: `src/storage/graph-storage.ts`
- Migration script: `migrate-db.js`